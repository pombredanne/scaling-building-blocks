<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Scalability Workshop</title>

	<meta name="description" content="Prepare your website for the big show.">
	<meta name="author" content="val.hoffman@gmail.com, val@tikalk.com" />
	<meta name="viewport" content="width=device-width, maximum-scale=1.0, initial-scale=1.0, user-scalable=yes" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<link href="simple.css" rel="stylesheet" type="text/css" />
	<link href="basic-animations.css" rel="stylesheet" type="text/css" />

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type="text/javascript" src="jmpress.js"></script>
</head>
<body>

<div id="simple">
	<div id="home" ~s>
		~n
		<h1 ~m>What will be covered</h1>
		<ul>
			<li ~m>When we will need this?</li>
			<li ~m>Concurrent massive landing</li>
			<li ~m>The system is under stress</li>
			<li ~m>Response time is growing</li>
			<li ~m>If you want peaceful life, prepare yourself for the battle!</li>
		</ul>
		<br/>
		<h2 ~m>Prerequisites</h2>
		<p ~m>sudo apt-get install siege memcached redis<p>
	</div>

	<div id="home" ~s>
		~n
		<h2 ~m>Main Topics</h2>
		<ul>
			<li ~m>Optimize the code</li>
				<ul>
					<li ~m>Profile, find bottlenecks with existing tools</li>
					<li ~m>Delayed Jobs</li>
					<li ~m>Replace software with services</li>
						<ul>
							<li ~m>Solr for search</li>
							<li ~m>Sinatra for computations etc.</li>
						</ul>
				</ul>
			<li ~m>Database tweaks</li>
			<ul>
				<li ~m>In-memory DB - Redis</li>
				<li ~m>Fine-tune existing MySQL database:</li>
					<ul>
					<li ~m>Indexes</li>
					<li ~m>Configuration</li>
					<li ~m>De-normalization</li>
					</ul>
			</ul>
			<li ~m>Types of caching</li>
			<li ~m>JRuby</li>
			<li ~m>Adding Hardware</li>
		</ul>
	</div>

	<div id="home" ~s>
		~n
		<h2 ~m>What is web application?</h2><br/>
		<div ~m>By default SQLite is the development DB. <strong>It's not a production Database.</strong> </div><br/>
		<div ~m>But it's working just out of the box.</div><br/>
		<div ~m>This summarizes the following: Web applications are mainly just a... <span data-jmpress="drive-left after 3500ms step" style="color:#4f4">Database.</span></div><br/>
		<div ~m>It's just a convenient concept. <br/>
			So <strong>better algorithms for data manipulation give us horizontal scalability</strong>.</div><br/>
		<div ~m>Other types of scaling include adding processing power, use external services etc.</div>
	</div>


	<div id="home" ~s>
		~n
		<h3 ~m>Let's create our application</h3>
		<div ~m>We will use a prepared app. Instead of carrying a large database, we'll just generate a few records, make relations and clone them several thousand times like so:</div>
		
		<code>
			<pre ~m>
			plast = Product.last
			for i in 0..4000
			    dupobj = plast.dup
			    dupobj.image = plast.image
			    dupobj.save!
			end
			</pre>
		</code>

		<code ~m>
			<pre ~m>
			# Populate the likes and reviews
			# 100 times randomly add likes and reviews to products
			like_ids_range = Like.first.id..Like.last.id
			review_ids_range = Review.first.id..Review.last.id
			product_ids_range = Product.first.id..Product.last.id
			for i in 1..5000
			  p = Product.find(Random.new.rand(product_ids_range))
			  p.likes << Like.find(Random.new.rand(like_ids_range))
			  p.reviews << Review.find(Random.rand(review_ids_range))
			  p.likes.first.likeability = Random.new.rand(1..5)
			  p.save!
			end
			</pre>
		</code>

		<div ~m>The scripts are located under <code>/migration/presentation</code></div>
	</div>

	<div ~s>
		~n
		<h2 ~m>Add the cache</h2>

		<h3 ~m>Add to development.rb:</h3>
		<ul>
			<li ~m>config.action_controller.perform_caching = true</li>
			<li ~m>config.cache_store = :file_store, "#{Rails.root}/tmp/cache"</li>
		</ul>

		<h3 ~m>And add to the products controller:</h3>
		<ul>
			<li ~m>caches_action :galery, :cache_path => :products_cache_path.to_proc</li>
			<li ~m>def products_cache_path<br/>
			current_user_id = current_user.nil?? 0 : current_user.id<br/>
			"home_index/#{params[:page]}/#{current_user_id}"<br/>
		end<br/></li>
		</ul>
		
		<div ~m style="background: #eee">
			Transaction rate:	       84.42 trans/sec   <span data-jmpress="drive-left after 4000ms step" style="color:#4f4">WOW!!</span><br/>
			And once again:<br/>
			Transaction rate:	       91.20 trans/sec   (Which makes sense.) <span data-jmpress="drive-left after 4300ms step" style="color:#4f4">Weee!!</span><br/><br/>
		</div>
	</div>

	<div id="home" ~s>
		~n
		<h3 ~m>Measure, compare, drive conclusions!</h3>
		<div ~m>We'll use siege and Ruby's benchmark to measure the results. Like this:</div>
		
		<code>
			<pre ~m>
			require 'benchmark'
			Benchmark.measure { 1000.times { plast.dup.save! } }
			</pre>
		</code>

		<div ~m>We're measuring the <strong>relative time</strong>. On my Lenovo ThinkPad T500 with several other processes running the results were:</div>

		<div ~m>
			=>   5.590000   0.170000   5.760000 ( 89.742811)  =SECONDS=
		</div><br/>

		<div ~m>Once again, and the results are:</div>

		<div ~m>
			=>   5.650000   0.200000   5.850000 ( 91.374391)
		</div><br/>
		

		<div ~m>One more time:</div>

		<div ~m>
			=>   5.540000   0.220000   5.760000 ( 96.141258)
		</div><br/>


		<div ~m> From 3 requests per second to 96, that's difference!<br/>
			89.7 -> 91.37 -> 96.14 For only one table with less than 10 columns!
		</div>
	</div>

	<div ~s>
		~n
		<h3 ~m>rails s Puma:</h3>
		<div ~m>
			Transaction rate:	       97.84 trans/sec  (Even better)<br/>

			[More detailed explanation of caches_action goes here, in addition to descriptions of other caching types]<br/>
			http://guides.rubyonrails.org/caching_with_rails.html<br/>
		</div>
	</div>
	<div ~s>
		~n
		<p ~m>You might think it is boring...</p>
	</div>
	<div ~s>
		~n
		<p ~m>but that is the point. This is a simple example.</p>
	</div>
	<div ~s>
		~n
		<p ~m><b>substep 0 + 1s</b></p>
    </div>
</div>

<script type="text/javascript">
$(function() {
	$('#simple').jmpress();
});
</script>

</body>
</html>